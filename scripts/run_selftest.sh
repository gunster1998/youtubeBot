#!/bin/bash

# üß™ –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ YouTube Bot
# –ê–≤—Ç–æ—Ä: AI Assistant
# –í–µ—Ä—Å–∏—è: 1.0

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}"
}

echo "üß™ –ó–∞–ø—É—Å–∫ —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ YouTube Bot —Å –ø—Ä–æ–∫—Å–∏"
echo "============================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ config.env
if [ ! -f "config.env" ]; then
    error "–§–∞–π–ª config.env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ config.env –Ω–∞ –æ—Å–Ω–æ–≤–µ env.example"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
log "üîç –ü—Ä–æ–≤–µ—Ä—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."

missing_deps=0

if ! command -v go &> /dev/null; then
    error "Go –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    missing_deps=1
fi

if ! command -v yt-dlp &> /dev/null; then
    error "yt-dlp –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    missing_deps=1
fi

if ! command -v curl &> /dev/null; then
    error "curl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    missing_deps=1
fi

if [ $missing_deps -eq 1 ]; then
    error "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
    exit 1
fi

log "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É
log "üî® –ö–æ–º–ø–∏–ª–∏—Ä—É—é —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É..."
if go build -o selftest scripts/selftest.go; then
    log "‚úÖ –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞"
else
    error "‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É
log "üöÄ –ó–∞–ø—É—Å–∫–∞—é —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É..."
./selftest

# –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
rm -f selftest

log "üéâ –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

