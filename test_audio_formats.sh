#!/bin/bash

# –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç–æ–≤
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –≤ MP3, –∞ –Ω–µ WebM

echo "üéµ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç–æ–≤..."
echo "=================================="

# –¢–µ—Å—Ç–æ–≤—ã–π YouTube URL (–∫–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
TEST_URL="https://www.youtube.com/watch?v=dQw4w9WgXcQ"

echo "üìã –¢–µ—Å—Ç–æ–≤—ã–π URL: $TEST_URL"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å yt-dlp
echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é yt-dlp..."
if ! command -v yt-dlp &> /dev/null; then
    echo "‚ùå yt-dlp –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ yt-dlp —Å–Ω–∞—á–∞–ª–∞."
    exit 1
fi

echo "‚úÖ yt-dlp –Ω–∞–π–¥–µ–Ω: $(yt-dlp --version)"
echo ""

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–æ–≤
TEST_DIR="/tmp/youtube_bot_audio_test"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"

echo "üìÅ –¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–ø–∫–∞: $TEST_DIR"
echo ""

# –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º–∞—Ç–æ–≤
echo "üîç –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤..."
yt-dlp --list-formats --no-playlist "$TEST_URL" > formats.txt 2>&1

if [ $? -eq 0 ]; then
    echo "‚úÖ –°–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω"
    
    # –ò—â–µ–º –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç—ã
    echo ""
    echo "üéµ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç—ã:"
    grep -i "audio" formats.txt | head -5
    echo ""
    
    # –ò—â–µ–º WebM –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç—ã
    echo "üîç WebM –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç—ã:"
    grep -i "webm.*audio\|audio.*webm" formats.txt || echo "–ù–µ—Ç WebM –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç–æ–≤"
    echo ""
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤"
    exit 1
fi

# –¢–µ—Å—Ç 2: –°–∫–∞—á–∏–≤–∞–µ–º –∞—É–¥–∏–æ –≤ MP3
echo "üéµ –¢–µ—Å—Ç 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ –≤ MP3..."
echo "–ö–æ–º–∞–Ω–¥–∞: yt-dlp --extract-audio --audio-format mp3 --audio-quality 0 --output 'test_audio.%(ext)s' '$TEST_URL'"

yt-dlp --extract-audio --audio-format mp3 --audio-quality 0 --output "test_audio.%(ext)s" "$TEST_URL" > download.log 2>&1

if [ $? -eq 0 ]; then
    echo "‚úÖ –ê—É–¥–∏–æ —Å–∫–∞—á–∞–Ω–æ"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    echo ""
    echo "üìÅ –°–∫–∞—á–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
    ls -la *.mp3 2>/dev/null || echo "MP3 —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    ls -la *.webm 2>/dev/null || echo "WebM —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo ""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
    if [ -f "test_audio.mp3" ]; then
        echo "‚úÖ –£—Å–ø–µ—Ö! –ê—É–¥–∏–æ —Å–∫–∞—á–∞–Ω–æ –≤ MP3 —Ñ–æ—Ä–º–∞—Ç–µ"
        file test_audio.mp3
    else
        echo "‚ùå –û—à–∏–±–∫–∞! MP3 —Ñ–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–Ω"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏:"
        ls -la
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞—É–¥–∏–æ"
    echo "–õ–æ–≥ –æ—à–∏–±–∫–∏:"
    cat download.log
fi

echo ""
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤..."
cd /
rm -rf "$TEST_DIR"

echo "‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
