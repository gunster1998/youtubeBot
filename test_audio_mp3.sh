#!/bin/bash

# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –∞—É–¥–∏–æ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ MP3 —Ñ–æ—Ä–º–∞—Ç–µ
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –≤—Å–µ –∞—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ MP3

echo "üéµ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∞—É–¥–∏–æ –≤ MP3 —Ñ–æ—Ä–º–∞—Ç"
echo "=============================================="

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
TEST_DIR="/tmp/youtube_bot_audio_mp3_test"
mkdir -p "$TEST_DIR"

# –¢–µ—Å—Ç–æ–≤—ã–π YouTube URL (–∫–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞)
TEST_URL="https://www.youtube.com/watch?v=dQw4w9WgXcQ"

echo "üìÅ –¢–µ—Å—Ç–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $TEST_DIR"
echo "üîó –¢–µ—Å—Ç–æ–≤—ã–π URL: $TEST_URL"

# –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
rm -f "$TEST_DIR"/*

echo ""
echo "üîç –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤"
echo "-----------------------------------"

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º–∞—Ç–æ–≤
yt-dlp --list-formats "$TEST_URL" > "$TEST_DIR/formats.txt" 2>&1

if [ $? -eq 0 ]; then
    echo "‚úÖ –°–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø–æ–ª—É—á–µ–Ω"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç—ã
    echo ""
    echo "üéµ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç—ã:"
    grep -i "audio" "$TEST_DIR/formats.txt" | head -5
    
    # –ò—â–µ–º WebM –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç—ã
    echo ""
    echo "üîç WebM –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç—ã (–¥–æ–ª–∂–Ω—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ MP3):"
    grep -i "webm.*audio" "$TEST_DIR/formats.txt" | head -3
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤"
    exit 1
fi

echo ""
echo "üéµ –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞—É–¥–∏–æ"
echo "---------------------------------------"

# –°–∫–∞—á–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –∞—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç
AUDIO_FORMAT=$(grep -i "audio" "$TEST_DIR/formats.txt" | head -1 | awk '{print $1}')

if [ -n "$AUDIO_FORMAT" ]; then
    echo "üì• –°–∫–∞—á–∏–≤–∞—é –∞—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç: $AUDIO_FORMAT"
    
    # –°–∫–∞—á–∏–≤–∞–µ–º —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤ MP3
    yt-dlp \
        --format "$AUDIO_FORMAT" \
        --extract-audio \
        --audio-format mp3 \
        --audio-quality 0 \
        --output "$TEST_DIR/%(id)s_%(format_id)s.%(ext)s" \
        "$TEST_URL"
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ê—É–¥–∏–æ —Å–∫–∞—á–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ MP3
        echo ""
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Å–∫–∞—á–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:"
        ls -la "$TEST_DIR"/*.mp3 2>/dev/null
        
        if ls "$TEST_DIR"/*.mp3 >/dev/null 2>&1; then
            echo "‚úÖ –£–°–ü–ï–•: –ê—É–¥–∏–æ —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ MP3!"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç WebM —Ñ–∞–π–ª–æ–≤
            if ls "$TEST_DIR"/*.webm >/dev/null 2>&1; then
                echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞–π–¥–µ–Ω—ã WebM —Ñ–∞–π–ª—ã (–Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å):"
                ls -la "$TEST_DIR"/*.webm
            else
                echo "‚úÖ WebM —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            fi
            
        else
            echo "‚ùå –û–®–ò–ë–ö–ê: MP3 —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            echo "üìÅ –§–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
            ls -la "$TEST_DIR"/
        fi
        
    else
        echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞—É–¥–∏–æ"
    fi
else
    echo "‚ùå –ê—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

echo ""
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
rm -rf "$TEST_DIR"

echo ""
echo "üéµ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"




