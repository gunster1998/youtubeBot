#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ YouTube Bot

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ YouTube Bot..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ config.env
if [ ! -f "config.env" ]; then
    echo "âŒ Ð¤Ð°Ð¹Ð» config.env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    echo "ðŸ“‹ Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ config.env.example Ð² config.env Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ ÐµÐ³Ð¾:"
    echo "   cp config.env.example config.env"
    echo "   nano config.env"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ yt-dlp
if ! command -v yt-dlp &> /dev/null; then
    echo "âŒ yt-dlp Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ!"
    echo "ðŸ“‹ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ yt-dlp:"
    echo "   ./install_ytdlp.sh"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº
mkdir -p downloads

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ ÐºÑÑˆÐ°
mkdir -p ../cache

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
source config.env

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
    echo "âŒ TELEGRAM_BOT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð² config.env"
    exit 1
fi

echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°"
echo "ðŸ¤– Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°: ${TELEGRAM_BOT_TOKEN:0:10}..."
echo "ðŸŒ API URL: ${TELEGRAM_API_URL:-http://127.0.0.1:8081}"

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
go mod tidy
go mod download

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
go build -o youtubeBot_async cmd/bot/main_async.go

if [ $? -ne 0 ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
    echo "ðŸ”§ ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸:"
    echo "   go get github.com/mattn/go-sqlite3"
    echo "   go mod tidy"
    exit 1
fi

echo "âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð±Ñ€Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
echo "ðŸŽ¬ Ð—Ð°Ð¿ÑƒÑÐº Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ð±Ð¾Ñ‚Ð°..."
echo "ðŸ“Š ÐžÑ‡ÐµÑ€ÐµÐ´ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº: 3 Ð²Ð¾Ñ€ÐºÐµÑ€Ð°"
echo "ðŸ’¾ ÐšÑÑˆ: 20 Ð“Ð‘"
echo "ðŸ”„ ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°: Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°"
echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ: ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð²Ð¸Ð´ÐµÐ¾ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‚ÑÑ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼"
echo ""
echo "ðŸ›‘ Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Telegram API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
if ! curl -s http://127.0.0.1:8081/health > /dev/null 2>&1; then
    echo "âš ï¸ Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Telegram API Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8081"
    echo "ðŸ”§ Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ telegram-bot-api Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½:"
    echo "   nohup /usr/local/bin/telegram-bot-api --api-id=27638369 --api-hash=0d3bea3f12b4bf0bce53fc6f19cccd60 --local --http-port=8081 --http-ip-address=127.0.0.1 > telegram-api.log 2>&1 &"
    echo ""
fi

./youtubeBot_async
